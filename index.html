<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Все предыдущие метатеги и стили остаются без изменений -->
    <!-- Добавим только новый стиль для уведомлений -->
    <style>
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tg-button-color);
            color: var(--tg-button-text-color);
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 80%;
            text-align: center;
        }
        
        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Весь предыдущий HTML остаётся без изменений -->
    <!-- Добавляем элемент для уведомлений -->
    <div class="notification" id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация Telegram WebApp
            const tg = window.Telegram.WebApp;
            tg.expand();
            tg.enableClosingConfirmation();
            
            // Получаем данные пользователя
            const user = tg.initDataUnsafe.user || {};
            const userId = user.id;
            const userName = [user.first_name, user.last_name].filter(Boolean).join(' ');
            
            // Функция для показа уведомлений
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, duration);
            }
            
            // Модифицируем функции работы с группами
            function loadGroups() {
                const savedGroups = localStorage.getItem('studentGroups') || '{}';
                return JSON.parse(savedGroups);
            }
            
            function saveGroups(groups) {
                localStorage.setItem('studentGroups', JSON.stringify(groups));
            }
            
            function loadGroupMembers() {
                const savedMembers = localStorage.getItem('groupMembers') || '{}';
                return JSON.parse(savedMembers);
            }
            
            function saveGroupMembers(members) {
                localStorage.setItem('groupMembers', JSON.stringify(members));
            }
            
            // Проверка доступа пользователя к группе
            function getUserGroups() {
                const members = loadGroupMembers();
                const userGroups = [];
                
                for (const groupName in members) {
                    if (members[groupName].includes(userId)) {
                        userGroups.push(groupName);
                    }
                }
                
                return userGroups;
            }
            
            // Обновлённая функция инициализации групп
            function initGroups() {
                let groups = loadGroups();
                const members = loadGroupMembers();
                
                // Если это первый запуск, создаём демо-группы
                if (Object.keys(groups).length === 0) {
                    groups = {
                        'ИВТ-21': [],
                        'ПИ-21': [],
                        'ФИИТ-21': []
                    };
                    saveGroups(groups);
                }
                
                // Если пользователь ещё не состоит ни в одной группе
                const userGroups = getUserGroups();
                if (userGroups.length === 0 && userId) {
                    // Предлагаем первую доступную группу
                    const firstGroup = Object.keys(groups)[0];
                    if (!members[firstGroup]) members[firstGroup] = [];
                    members[firstGroup].push(userId);
                    saveGroupMembers(members);
                    
                    showNotification(`Вы добавлены в группу ${firstGroup}`);
                }
                
                return groups;
            }
            
            // Обновлённая функция обновления интерфейса групп
            function updateGroupSelect() {
                const userGroups = getUserGroups();
                const allGroups = initGroups();
                const groupSelect = document.getElementById('groupSelect');
                const eventGroupsContainer = document.getElementById('eventGroupsContainer');
                
                // Очищаем и обновляем select
                groupSelect.innerHTML = '';
                
                if (userGroups.length > 1) {
                    const allOption = document.createElement('option');
                    allOption.value = 'all';
                    allOption.textContent = 'Все мои группы';
                    groupSelect.appendChild(allOption);
                }
                
                // Очищаем и обновляем контейнер групп в модальном окне
                eventGroupsContainer.innerHTML = '';
                
                userGroups.forEach(group => {
                    // Добавляем в select
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupSelect.appendChild(option);
                    
                    // Добавляем чекбоксы в модальное окно
                    const groupCheckbox = document.createElement('div');
                    groupCheckbox.className = 'form-check';
                    groupCheckbox.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${group}" id="group-${group}" checked>
                        <label class="form-check-label" for="group-${group}">
                            ${group}
                        </label>
                    `;
                    eventGroupsContainer.appendChild(groupCheckbox);
                });
                
                // Обновляем список групп в модальном окне управления
                renderGroupsList();
            }
            
            // Обновлённая функция сохранения события
            document.getElementById('saveEventBtn').addEventListener('click', function() {
                const eventId = document.getElementById('eventId').value;
                const eventTitle = document.getElementById('eventTitle').value.trim();
                const eventType = document.getElementById('eventType').value;
                const eventStart = document.getElementById('eventStart').value;
                const eventEnd = document.getElementById('eventEnd').value;
                const eventLocation = document.getElementById('eventLocation').value.trim();
                const eventTeacher = document.getElementById('eventTeacher').value.trim();
                const eventDescription = document.getElementById('eventDescription').value.trim();
                const eventRepeat = document.getElementById('eventRepeat').value;
                const repeatUntil = document.getElementById('repeatUntil').value;
                
                // Получаем выбранные группы (только те, в которых состоит пользователь)
                const selectedGroups = [];
                const userGroups = getUserGroups();
                document.querySelectorAll('#eventGroupsContainer input[type="checkbox"]:checked').forEach(checkbox => {
                    if (userGroups.includes(checkbox.value)) {
                        selectedGroups.push(checkbox.value);
                    }
                });
                
                if (!eventTitle) {
                    showNotification('Укажите название предмета');
                    return;
                }
                
                if (selectedGroups.length === 0) {
                    showNotification('Выберите хотя бы одну группу');
                    return;
                }
                
                const newEvent = {
                    id: eventId || Date.now().toString(),
                    title: eventTitle,
                    start: eventStart,
                    end: eventEnd,
                    extendedProps: {
                        type: eventType,
                        location: eventLocation,
                        teacher: eventTeacher,
                        description: eventDescription,
                        groups: selectedGroups,
                        createdBy: userId // Добавляем информацию о создателе
                    }
                };
                
                let events = loadEvents();
                
                if (eventId) {
                    // Редактирование существующего события
                    events = events.map(e => e.id === eventId ? newEvent : e);
                    showNotification('Занятие обновлено');
                } else {
                    // Добавление нового события
                    events.push(newEvent);
                    showNotification('Занятие добавлено');
                    
                    // Обработка повторяющихся событий
                    if (eventRepeat !== 'none' && repeatUntil) {
                        const startDate = new Date(eventStart);
                        const untilDate = new Date(repeatUntil);
                        let nextDate;
                        
                        switch (eventRepeat) {
                            case 'weekly':
                                nextDate = new Date(startDate);
                                nextDate.setDate(nextDate.getDate() + 7);
                                break;
                            case 'monthly':
                                nextDate = new Date(startDate);
                                nextDate.setMonth(nextDate.getMonth() + 1);
                                break;
                        }
                        
                        while (nextDate <= untilDate) {
                            const recurringEvent = {
                                ...newEvent,
                                id: Date.now().toString(),
                                start: nextDate.toISOString().slice(0, 16),
                                end: new Date(new Date(eventEnd).getTime() + (nextDate - startDate)).toISOString().slice(0, 16)
                            };
                            
                            events.push(recurringEvent);
                            
                            switch (eventRepeat) {
                                case 'weekly':
                                    nextDate.setDate(nextDate.getDate() + 7);
                                    break;
                                case 'monthly':
                                    nextDate.setMonth(nextDate.getMonth() + 1);
                                    break;
                            }
                        }
                    }
                }
                
                saveEvents(events);
                calendar.refetchEvents();
                
                // Автоматическое закрытие модального окна через 1 секунду
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                }, 1000);
            });
            
            // Обновлённая фильтрация событий
            calendar.setOption('eventDidMount', function(info) {
                const selectedGroup = document.getElementById('groupSelect').value;
                const userGroups = getUserGroups();
                
                // Проверяем доступ пользователя к событию
                const eventGroups = info.event.extendedProps.groups || [];
                const hasAccess = eventGroups.some(group => userGroups.includes(group));
                
                if (!hasAccess) {
                    info.el.style.display = 'none';
                    return;
                }
                
                if (selectedGroup !== 'all') {
                    if (!eventGroups.includes(selectedGroup)) {
                        info.el.style.display = 'none';
                    }
                }
            });
            
            // Инициализация при загрузке
            updateGroupSelect();
            
            // Показываем приветственное сообщение
            if (userName) {
                setTimeout(() => {
                    showNotification(`Добро пожаловать, ${userName}!`);
                }, 1000);
            }
        });
    </script>
</body>
</html>
